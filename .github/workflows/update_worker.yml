name: Daily Sync _worker.js from zizifn/edgetunnel

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC é›¶ç‚¹è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write  # ğŸ”‘ å…è®¸å†™å…¥æƒé™ï¼ˆå¿…é¡»ï¼ï¼‰

jobs:
  sync-worker:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆä½¿ç”¨ GITHUB_TOKEN æ”¯æŒæ¨é€ï¼‰
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–ä¸Šæ¸¸æœ€æ–° commit SHA
        id: get_sha
        run: |
          curl -s https://api.github.com/repos/zizifn/edgetunnel/commits/main \
            | grep '"sha"' | head -n 1 | cut -d '"' -f 4 > upstream_sha.txt
          echo "sha=$(cat upstream_sha.txt)" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        id: check_update
        run: |
          if [ ! -f version.txt ]; then
            echo "é¦–æ¬¡è¿è¡Œï¼Œéœ€æ›´æ–°"
            echo "need_update=true" >> $GITHUB_OUTPUT
          elif ! cmp -s upstream_sha.txt version.txt; then
            echo "ä¸Šæ¸¸æœ‰æ–°ç‰ˆæœ¬ï¼Œéœ€æ›´æ–°"
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "ç‰ˆæœ¬æœªå˜ï¼Œæ— éœ€æ›´æ–°"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi

      - name: åŒæ­¥ _worker.js å¹¶æ›´æ–° version.txt
        if: steps.check_update.outputs.need_update == 'true'
        run: |
          curl -sL https://raw.githubusercontent.com/zizifn/edgetunnel/main/src/worker-with-socks5-experimental.js -o _worker.js
          cp upstream_sha.txt version.txt
          echo "updated=true" >> $GITHUB_ENV

      - name: æäº¤å¹¶æ¨é€å˜æ›´
        if: env.updated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _worker.js version.txt
          git commit -m "è‡ªåŠ¨åŒæ­¥ _worker.jsï¼Œä¸Šæ¸¸ç‰ˆæœ¬ $(cat version.txt)"
          git push origin HEAD
